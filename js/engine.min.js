String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),String.prototype.ltrim||(String.prototype.ltrim=function(){return this.replace(/^\s+/,"")}),String.prototype.rtrim||(String.prototype.rtrim=function(){return this.replace(/\s+$/,"")}),String.prototype.startsWith||(String.prototype.startsWith=function(t){return 0===this.lastIndexOf(t,0)});var Dedalus,story;!function(){"use strict";function makeMessageCenter(){function t(t,e,n){r.hasOwnProperty(t)||(r[t]={}),r[t][e]=n}function e(t,e){r.hasOwnProperty(t)||(r[t]={}),r[t].hasOwnProperty(e)&&delete r[t][e]}function n(t,e){var n;if(r.hasOwnProperty(t))for(n in r[t])r[t].hasOwnProperty(n)&&r[t][n](e)}var r={};return{publish:n,subscribe:t,unsubscribe:e}}Dedalus=function(t){this.options=t,this.options&&(this.dedleeSource=this.options.dedleeSource,this.domSource=this.options.domSource,this._story=this.options?this.parseStory():{}),this._story||(this._story={}),this.storyUndo={},this._storyUndo={},this.messageCenter=makeMessageCenter(),story=this.generateEmptyStory()},Dedalus.prototype.parseStory=function(){function getTitleLocal(t){return t.find("title").html()||"A Dedalus Story"}function getInitScript(t){return t.find("initscript").text()}function getIntroLocal(t){return t.find("#intro").html()}function getObjects(parent){var objects={};return parent.find("obj, character").each(function(){function getActiveActions(){var t,e={},n=objects[id];for(t in n.actions)n.actions.hasOwnProperty(t)&&n.actions[t].when()&&(e[t]=n.actions[t]);return e}var obj=$(this),id=obj.attr("id"),inventoryName=obj.attr("inventoryName");objects[id]={actions:{},inventoryName:inventoryName},obj.find("action").each(function(){var whenCheck=function(){return!0},action=$(this),when=action.find("when").text()||void 0,withCombinations={},hasCombinations=!1;void 0!==when&&(whenCheck=function(){return eval(when)}),action.find("when").remove(),action.find("with").each(function(){var t=$(this),e=t.attr("id"),n=doT.template(Dedalus.getRawContent(t));withCombinations[e]=n,hasCombinations=!0,t.remove()}),objects[id].actions[action.attr("id")]={when:whenCheck,content:doT.template(Dedalus.getRawContent(action)),hasWith:hasCombinations,"with":withCombinations}}),objects[id].getActiveActions=getActiveActions}),objects}function getParagraphs(t){var e={};return t.find("paragraph").each(function(){var t=$(this),n=t.attr("id");e[n]={content:doT.template(Dedalus.getRawContent(t))}}),e}function getPages(t){var e={};return t.find("page").each(function(){var t=$(this),n=t.attr("id");e[n]={objects:getObjects(t),paragraphs:getParagraphs(t),isFirst:t.hasClass("first")},t.find("obj, paragraph, character").remove(),e[n].content=doT.template(Dedalus.getRawContent(t))}),e}function getInitialCurrentPage(t){return t.find("page.first").attr("id")}function getInitialInventory(){return[]}function setBeforeAfterActions(t){_story.beforeEveryThing=t.find("beforeEveryThing").text(),_story.beforeEveryPageTurn=t.find("beforeEveryPageTurn").text(),_story.beforeEveryParagraphShown=t.find("beforeEveryParagraphShown").text(),_story.afterEveryThing=t.find("afterEveryThing").text(),_story.afterEveryPageTurn=t.find("afterEveryPageTurn").text(),_story.afterEveryParagraphShown=t.find("afterEveryParagraphShown").text()}var _story={currentPage:"",title:"",inventory:[],pages:{},paragraphs:{},objects:{},initialization:"",intro:"",numParagraphsShown:0,numPagesTurned:0,numParagraphsShownInPage:0,numTotalActions:0,numActionsPerformedInPage:0,combinationActionInProgress:!1,beforeEveryThing:function(){},beforeEveryPageTurn:function(){},beforeEveryParagraphShown:function(){},afterEveryThing:function(){},afterEveryPageTurn:function(){},afterEveryParagraphShown:function(){}},temporaryDomSourceCopy;return this.dedleeSource&&this.parseDedlee(this.dedleeSource,this.domSource),temporaryDomSourceCopy=this.domSource.children().clone(!0),_story.currentPage=getInitialCurrentPage(this.domSource),_story.initialization=getInitScript(this.domSource),_story.intro=getIntroLocal(this.domSource),_story.inventory=getInitialInventory(this.domSource),_story.objects=getObjects(this.domSource),_story.pages=getPages(this.domSource),_story.paragraphs=getParagraphs(this.domSource),_story.title=getTitleLocal(this.domSource),setBeforeAfterActions(this.domSource),this.domSource.html("").append(temporaryDomSourceCopy),_story},Dedalus.prototype.generateEmptyStory=function(){return{currentPageIs:this.currentPageIs.bind(this),currentPage:this.currentPage.bind(this),removeFromInventory:this.removeFromInventory.bind(this),putInInventory:this.putInInventory.bind(this),isInInventory:this.isInInventory.bind(this),getNumTotalActions:this.getNumTotalActions.bind(this),getNumActionsPerformedInPage:this.getNumActionsPerformedInPage.bind(this),getNumPagesTurned:this.getNumPagesTurned.bind(this),getNumParagraphsShown:this.getNumParagraphsShown.bind(this),getNumParagraphsShownInPage:this.getNumParagraphsShownInPage.bind(this),turnTo:this.turnTo.bind(this),disable:this.disable.bind(this),enable:this.enable.bind(this),showParagraph:this.showParagraph.bind(this),endGame:this.endGame.bind(this)}},Dedalus.prototype.print=function(t,e){this.storyUndo=jQuery.extend(!0,{},story),this._storyUndo=jQuery.extend(!0,{},this._story),this.afterUndoSave(),this.executeBeforeEveryThing(),this.executePrinting(t,e),this.executeAfterEveryThing(),this._story.numTotalActions+=1,this._story.numActionsPerformedInPage+=1},Dedalus.prototype.turnTo=function(t,e){var n=e||!1,r=this.getPage(t),o=r.content;this.executeBeforeEveryPageTurn(),n?this.print(o):(this.print(o,!0),"intro"!==t&&this.setCurrentPageId(t)),this.executeAfterEveryPageTurn(),this._story.numParagraphsShownInPage=0,this._story.numActionsPerformedInPage=0,this._story.numPagesTurned+=1},Dedalus.prototype.showParagraph=function(t){var e=this.getParagraph(t),n=e.content;this.executeBeforeEveryParagraphShown(),this.print(n),this.executeAfterEveryParagraphShown(),this._story.numParagraphsShown+=1,this._story.numParagraphsShownInPage+=1},Dedalus.prototype.getPage=function(t){return this._story.pages[t]},Dedalus.prototype.getObject=function(t){var e=this.getCurrentPage().objects[t];return void 0!==e?e:this._story.objects[t]},Dedalus.prototype.getActionsForObject=function(t){var e,n=[],r=this.getObject(t);for(e in r.actions)r.actions.hasOwnProperty(e)&&r.actions[e].when()&&n.push(r.actions[e]);return n},Dedalus.prototype.getParagraph=function(t){var e=this.getCurrentPage().paragraphs[t];return void 0!==e?e:this._story.paragraphs[t]},Dedalus.prototype.activateCombinationAction=function(){this._story.combinationActionInProgress=!0},Dedalus.prototype.disactivateCombinationAction=function(){this._story.combinationActionInProgress=!1},Dedalus.prototype.isCombinationAction=function(){return this._story.combinationActionInProgress},Dedalus.prototype.currentPageIs=function(t){return this._story.currentPage===t},Dedalus.prototype.currentPage=function(){return this._story.currentPage},Dedalus.prototype.removeFromInventory=function(t){var e=this._story.inventory.indexOf(t);e>-1&&this._story.inventory.splice(e,1),this.messageCenter.publish("inventory","inventoryChanged")},Dedalus.prototype.putInInventory=function(t){this.removeFromInventory(t),this._story.inventory.push(t),this.messageCenter.publish("inventory","inventoryChanged")},Dedalus.prototype.isInInventory=function(t){return-1!==this._story.inventory.indexOf(t)},Dedalus.prototype.executeInitialization=function(){eval(this._story.initialization)},Dedalus.prototype.getIntro=function(){return this._story.intro},Dedalus.prototype.getTitle=function(){return this._story.title},Dedalus.prototype.getInventory=function(){return this._story.inventory},Dedalus.prototype.getCurrentPageId=function(){return this._story.currentPage},Dedalus.prototype.setCurrentPageId=function(t){this._story.currentPage=t},Dedalus.prototype.getCurrentPage=function(){return this.getPage(this._story.currentPage)},Dedalus.prototype.getNumTotalActions=function(){return this._story.numTotalActions},Dedalus.prototype.getNumActionsPerformedInPage=function(){return this._story.numActionsPerformedInPage},Dedalus.prototype.getNumPagesTurned=function(){return this._story.numPagesTurned},Dedalus.prototype.getNumParagraphsShown=function(){return this._story.numParagraphsShown},Dedalus.prototype.getNumParagraphsShownInPage=function(){return this._story.numParagraphsShownInPage},Dedalus.prototype.resetCounters=function(){this._story.numPagesTurned=0,this._story.numParagraphsShown=0,this._story.numParagraphsShownInPage=0,this._story.numTotalActions=0,this._story.numActionsPerformedInPage=0},Dedalus.prototype.undo=function(){story=jQuery.extend({},this.storyUndo),this._story=jQuery.extend({},this._storyUndo),this.executeUndo()},Dedalus.prototype.save=function(){this.executeSave(story,this._story)},Dedalus.prototype.restore=function(){var t=this.getRestoreData(),e=t[0],n=t[1];this.saveAvailable()&&(this._story=jQuery.extend(!0,this.parseStory(this.options.domSource),n),story=jQuery.extend(!0,this.generateEmptyStory(),e),this.executeRestore())},Dedalus.prototype.reset=function(){this._story=this.parseStory(this.options.domSource),story=this.generateEmptyStory(),this.executeReset()},Dedalus.prototype.executeBeforeEveryThing=function(){eval(this._story.beforeEveryThing)},Dedalus.prototype.executeBeforeEveryPageTurn=function(){eval(this._story.beforeEveryPageTurn)},Dedalus.prototype.executeBeforeEveryParagraphShown=function(){eval(this._story.beforeEveryParagraphShown)},Dedalus.prototype.executeAfterEveryThing=function(){eval(this._story.afterEveryThing)},Dedalus.prototype.executeAfterEveryPageTurn=function(){eval(this._story.afterEveryPageTurn)},Dedalus.prototype.executeAfterEveryParagraphShown=function(){eval(this._story.afterEveryParagraphShown)},Dedalus.prototype.executePrinting=function(){},Dedalus.prototype.executeUndo=function(){},Dedalus.prototype.executeSave=function(){},Dedalus.prototype.saveAvailable=function(){},Dedalus.prototype.executeRestore=function(){},Dedalus.prototype.executeReset=function(){},Dedalus.prototype.getRestoreData=function(){},Dedalus.prototype.afterUndoSave=function(){},Dedalus.prototype.disable=function(){},Dedalus.prototype.enable=function(){},Dedalus.prototype.endGame=function(){},Dedalus.getRawContent=function(t){var e=t.contents(),n="";return e.each(function(){n+=3===this.nodeType?this.nodeValue:this.outerHTML}),n}}();var DedalusWeb;!function(){"use strict";DedalusWeb=function(t){var e=this;Dedalus.call(this,t),this.domTarget=t.domTarget,this.inventoryTarget=t.inventoryTarget,this.titleTarget=t.titleTarget,this.interactionTarget=t.interactionTarget,this.undoTarget=t.undoTarget,this.saveTarget=t.saveTarget,this.restoreTarget=t.restoreTarget,this.resetTarget=t.resetTarget,this.undoStageTarget=t.undoStageTarget,this.domTargetParent=t.domTargetParent,this.onPrint=t.onPrint?t.onPrint.bind(this):this.onPrint,this.undoTarget.on("click",this.undo.bind(this)),this.saveTarget.on("click",this.save.bind(this)),this.restoreTarget.on("click",this.restore.bind(this)),this.resetTarget.on("click",this.reset.bind(this)),this.titleTarget.html(this.getTitle()),this.executeReset(),this.messageCenter.subscribe("inventory","dedalusWeb",this.updateInventory.bind(this)),$("body, html").on("click",function(){e.isCombinationAction()||(e.interactionTarget.hide(),e.disactivateCombinationAction())})},DedalusWeb.prototype=new Dedalus,DedalusWeb.prototype.handleInteractions=function(){function t(t,n,r,o){e.domTarget.find(t).each(function(){var t=$(this),i=t.attr(n),a=t.attr("id"),s=a?'data-id="'+t.attr("id")+'"':"",u='data-target-id="'+i+'"',h=t.hasClass("disabled"),c=t.text(),d=$('<a href="#" '+s+" "+u+">"+c+"</a>");d.on("click",function(t){return o(i,t),t.stopPropagation(),!1}),d.addClass(r),t.after(d),t.remove(),h&&e.disable(a)})}var e=this;t("turn","to","page",function(t){e.turnTo(t),e.interactionTarget.hide()}),t("interact","with","object",function(t,n){e.interactWith(t,n)}),t("show","paragraph","paragraph",function(t){e.showParagraph(t),e.interactionTarget.hide()})},DedalusWeb.prototype.interactWith=function(t,e){function n(e){return function(){e.hasWith?(a.activateCombinationAction(),a.interactionTarget.html("<ul></ul>"),$(a.domTarget).find("a.object").add($(a.inventoryTarget).find("a")).each(function(n,r){var o=$(r),i=$(o.prop("outerHTML")),s=i.attr("data-target-id"),u=a.getObject(s),h=i.text(),c=u.inventoryName||h,d=e["with"][s]||e.content;s!==t&&(i.text(c),i.on("click",function(){a.print(d),a.interactionTarget.hide(),a.handleInteractions(),a.disactivateCombinationAction()}),a.interactionTarget.find("ul").append(i),a.interactionTarget.find("ul>a").wrap("<li>"))})):(a.print(e.content),a.interactionTarget.hide(),a.handleInteractions(),a.disactivateCombinationAction())}}var r,o,i,a=this,s=this.getObject(t),u=s.getActiveActions(),h=$(e.target);this.interactionTarget.html("<ul></ul>");for(r in u)u.hasOwnProperty(r)&&(o=u[r].content,i=$('<a href="#" data-target-id="'+t+'">'+r+"</a>"),i.on("click",n(u[r])),this.interactionTarget.find("ul").append(i),this.interactionTarget.find("ul>a").wrap("<li>"),this.interactionTarget.css("left",h.offset().left-this.interactionTarget.width()/2+h.width()/2),this.interactionTarget.css("top",h.offset().top+20),this.interactionTarget.show());return u},DedalusWeb.prototype.updateInventory=function(){function t(t){return function(e){return i.interactWith(t,e),e.stopPropagation(),!1}}var e,n,r,o,i=this,a=this.getInventory();for(this.inventoryTarget.html("<ul></ul>"),e=0;e<a.length;e+=1)r=this.getObject(a[e]),o=r.inventoryName,n=$('<a href="#" data-target-id="'+a[e]+'">'+o+"</a>"),n.on("click",t(a[e])),this.inventoryTarget.find("ul").append(n),this.inventoryTarget.find("ul>a").wrap("<li>")},DedalusWeb.prototype.executePrinting=function(t,e){var n=e||!1,r="<p>"+t()+"</p>";n?this.onPrint(r,!0)&&this.domTarget.html(r):this.onPrint(r,!1)&&this.domTarget.append(r),this.handleInteractions()},DedalusWeb.prototype.executeUndo=function(){this.domTarget.html(""),this.undoStageTarget.appendTo(this.domTarget),this.updateInventory()},DedalusWeb.prototype.afterUndoSave=function(){this.undoStageTarget.html(""),this.undoStageTarget=this.domTarget.children().clone(!0)},DedalusWeb.prototype.executeSave=function(t,e){localStorage.story=JSON.stringify(t),localStorage._story=JSON.stringify(e)},DedalusWeb.prototype.saveAvailable=function(){return localStorage.story&&localStorage._story},DedalusWeb.prototype.getRestoreData=function(){return[jQuery.parseJSON(localStorage.story),jQuery.parseJSON(localStorage._story)]},DedalusWeb.prototype.executeRestore=function(){this.updateInventory(),this.turnTo(this.getCurrentPageId())},DedalusWeb.prototype.executeReset=function(){this.turnTo("intro"),this.turnTo(this.getCurrentPageId(),!0),this.resetCounters(),this.updateInventory(),this.executeInitialization(),this.interactionTarget.hide()},DedalusWeb.prototype.disable=function(t){var e,n,r,o=this.domTarget.find('a[data-id="'+t+'"]');o.length>0&&(e=o.get(0),n='<span data-id="'+t+'">'+o.text()+"</span>",r=$._data(e,"events").click[0].handler,o.after($(n).data("originalClickFn",r)),o.remove())},DedalusWeb.prototype.enable=function(t){var e=this.domTarget.find('span[data-id="'+t+'"]'),n='<a href="#" data-id="'+t+'">'+e.text()+"</a>",r=e.data("originalClickFn");e.after($(n).on("click",r)),e.remove()},DedalusWeb.prototype.endGame=function(){this.domTarget.find("a").off("click").contents().unwrap(),this.inventoryTarget.find("a").off("click").contents().unwrap()},DedalusWeb.prototype.onPrint=function(){return!0}}();